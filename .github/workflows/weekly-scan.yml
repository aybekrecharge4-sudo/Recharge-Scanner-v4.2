  name: Weekly Recharge Scanner                                                                                                                                                                                        
                                                            
  on:                                                                                                                                                                                                                  
    schedule:                                                                                                                                                                                                          
      - cron: "0 7 * * 1"
    workflow_dispatch:

  permissions:
    contents: write

  jobs:
    scan:
      runs-on: ubuntu-latest
      timeout-minutes: 15

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Python 3.11
          uses: actions/setup-python@v5
          with:
            python-version: "3.11"

        - name: Install dependencies
          run: pip install -r requirements.txt

        - name: Run scanner
          env:
            GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
            EMAIL_TO: ${{ secrets.EMAIL_TO }}
            EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
            SMTP_HOST: ${{ secrets.SMTP_HOST }}
            SMTP_PORT: ${{ secrets.SMTP_PORT }}
            SMTP_USER: ${{ secrets.SMTP_USER }}
            SMTP_PASS: ${{ secrets.SMTP_PASS }}
            DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}
            DASH_PASSWORD: ${{ secrets.DASH_PASSWORD }}
          run: python recharge_scanner_v4.py

        - name: Commit and push updated dashboard
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add index.html
            git diff --cached --quiet || git commit -m "Update dashboard $(date -u +%Y-%m-%d)"
            git push
